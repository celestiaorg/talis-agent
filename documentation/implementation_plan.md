``# Talis-API Implementation Plan This plan outlines step-by-step instructions to build the Talis-API service in Go for Linux servers. The service monitors system metrics using the Prometheus client and exposes REST endpoints as defined in the PRD. Branch-based development, unit/integration tests, and frequent GitHub pushes are expected throughout the process. --- ## Phase 1: Environment Setup 1. **Clone the Repository** - Action: Clone the repository from https://github.com/celestiaorg/talis-api on a new branch for development. - Location: Project root - Reference: PRD Section 1. Project Overview 2. **Install Go Environment and Dependencies** - Action: Ensure that Go is installed on your Linux machine and set up the GOPATH. (Use the system’s default Go version unless specified otherwise.) - Validation: Run `go version` to confirm installation. - Reference: Tech Stack Document 3. **Create Required Directories** - Action: Create the directory `/etc/talis-agent/` and a subdirectory `/etc/talis-agent/payload` for storing payloads. - Command Example: `sudo mkdir -p /etc/talis-agent/payload` - Reference: PRD Section 2, Configuration Loader 4. **Prepare a Script for Installation Setup** - Action: Create an installation script at `/scripts/setup.sh` that ensures the required directories and a sample configuration file exist. - Reference: PRD Section 5, Packaging and Deployment Tools 5. **Initialize Git Branches** - Action: Create branches for development (e.g., `dev` for features) and production (`main`) and push to GitHub regularly. - Reference: PRD Section 7, Development Process --- ## Phase 2: Backend Development 6. **Set Up the Main Application File** - Action: Create `main.go` in the project root to initialize the Fiber app, load configuration, set up logging, and register routes. - Reference: PRD Section 3, Core Features 7. **Implement Configuration Loader** - Action: In `config/config.go`, implement a loader that reads `/etc/talis-agent/config.yaml` for HTTP port (default 25550) and log level. - Validation: Test behavior when the file is missing or invalid (should log an error and exit). - Reference: PRD Section 4, Configuration Loader 8. **Initialize Logging in the App** - Action: Set up logging using `github.com/gofiber/fiber/v2/log` in `main.go`, defaulted to Info level unless overridden by configuration. - Reference: PRD Section 4, Logging and Error Handling 9. **Implement the /alive Endpoint** - Action: Create a handler in `handlers/alive.go` that responds with a JSON object and HTTP 200 OK. - Route: `/alive` - Reference: PRD Section 3, /alive Endpoint 10. **Implement the /metrics Endpoint** - Action: Create a handler in `handlers/metrics.go` that integrates the Prometheus client to expose system metrics (CPU, memory, disk, I/O, network) in a Prometheus-compatible format. - Route: `/metrics` - Reference: PRD Section 3, /metrics Endpoint 11. **Implement the /ip Endpoint** - Action: Create a handler in `handlers/ip.go`. Use a method to detect the public IP(s) of the host. Return multiple IPs as an array in JSON; if none, return an empty JSON object. - Route: `/ip` - Reference: PRD Section 3, /ip Endpoint 12. **Implement the /payload Endpoint** - Action: Create a handler in `handlers/payload.go` that accepts POST requests and writes the incoming payload data to `/etc/talis-agent/payload` (filename could include a timestamp or be fixed). - Route: `/payload` - Validation: Confirm that POSTing data stores the payload on disk. - Reference: PRD Section 3, /payload Endpoint 13. **Implement the /commands Endpoint** - Action: Create a handler in `handlers/commands.go` that accepts POST requests containing bash commands and pipes these commands to the system using Go’s `os/exec` package. Note: No authentication is applied. - Route: `/commands` - Validation: Use controlled tests to ensure the command executes and returns output. - Reference: PRD Section 3, /commands Endpoint 14. **Setup Routing in the Main Application** - Action: In `main.go`, import all endpoint handlers and mount them on the Fiber app with their corresponding routes. - Reference: PRD Section 3, Service Functionality 15. **Integrate Prometheus Client** - Action: In the `/metrics` handler, integrate the Prometheus Go client to capture and expose system metrics continuously. - Reference: PRD Section 3, Metrics Collection Endpoint 16. **Implement Error Logging for Network Issues and Others** - Action: Ensure that in all handlers (especially metrics collection and configuration loader), errors are caught and logged to a dedicated log file using the Fiber log library. - Reference: PRD Section 4, Logging and Error Handling 17. **Write Unit Tests for Each Handler** - Action: Create unit tests under `/tests/unit/` for each endpoint handler (e.g., `alive_test.go`, `metrics_test.go`, etc.). - Validation: Run `go test ./tests/unit/...` to verify 100% coverage of handler logic. - Reference: PRD Section 7, Testing 18. **Write Integration Tests** - Action: Create integration tests under `/tests/integration/` which start the Fiber app, simulate HTTP requests to each endpoint, and verify the responses (including error scenarios like missing config file). - Validation: Run `go test ./tests/integration/...` and confirm all tests pass. - Reference: PRD Section 7, Testing --- ## Phase 3: Integration 19. **Integrate Configuration Validation in Startup** - Action: Modify startup sequence in `main.go` to immediately exit with a logged error if `/etc/talis-agent/config.yaml` is missing or invalid. - Reference: PRD Section 4, Configuration Loader 20. **Validate Endpoint Functionality** - Action: Manually test each endpoint using curl commands: - `/alive` → Check for HTTP 200 and JSON response. - `/metrics` → Ensure Prometheus metrics are exposed. - `/ip` → Confirm correct JSON response based on public IP detection. - `/payload` → Send a POST and verify a file appears in `/etc/talis-agent/payload`. - `/commands` → Post a bash command and verify the command execution output. - Reference: PRD Section 3, Core Features --- ## Phase 4: Packaging & Deployment 21. **Create a Makefile** - Action: At the project root, create a `Makefile` that includes targets for building the binary, running tests, and building the .deb package. - Reference: PRD Section 5, Packaging and Deployment Tools 22. **Implement a Deb Packaging Script** - Action: Create a packaging script (e.g., `scripts/package.sh`) that packages the binary, config files, and necessary scripts into a .deb package. - Validation: Run the script locally and verify the .deb package contents. - Reference: PRD Section 5, Packaging and Deployment Tools 23. **Set Up GitHub Actions for Deb Package Build** - Action: Create a GitHub Actions workflow file in `.github/workflows/deb-package.yml` that triggers on push events and builds the .deb package using the Makefile. - Reference: PRD Section 5, Packaging and Deployment Tools 24. **Document the Build and Deployment Process** - Action: Create a README or a separate documentation file detailing steps to build, test, package, and deploy Talis-API. - Reference: PRD Section 5, Packaging and Deployment Tools 25. **Validate Full Build and Deployment Pipeline** - Action: Run the complete pipeline including tests, build, and .deb package creation, then verify installation on a fresh Linux environment. - Reference: PRD Section 5, Packaging and Deployment Tools --- ## Phase 5: Post-Deployment Testing & Maintenance 26. **Deploy to a Test Linux Server** - Action: Deploy the .deb package on a test Linux server and perform end-to-end testing to ensure all endpoints function as expected. - Validation: Use curl and monitor logs for errors. - Reference: PRD Section 7, Testing & Deployment 27. **Set Up Continuous Integration and Branching Workflow** - Action: Ensure that each feature branch is merged via pull requests and that tests run automatically in the CI pipeline. - Reference: PRD Section 7, Development Process 28. **Monitor Logs in Operational Environment** - Action: After deployment, verify that logs from `github.com/gofiber/fiber/v2/log` are correctly written to the designated log file and review periodically for network errors or misconfigurations. - Reference: PRD Section 4, Logging and Error Handling --- *Note: All steps are designed to be implemented with one action per step. Frequent commits should be made to GitHub during development on feature branches. Use AI assistance tools (Claude 3.7 Sonnet, Claude 3.5 Sonnet, GPT o1, GPT 4o, and Cursor) as needed for improved code generation and debugging support. This plan satisfies requirements for system metrics collection, payload handling, command execution, and reliable packaging/deployment as detailed in the PRD.``
